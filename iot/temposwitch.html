<!DOCTYPE HTML>
<html>
<head>
<style>
.canvasjs-chart-credit {
   display: none;
}
</style>
<script type="text/javascript">
window.onload = function () {
	// http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getObject-property
	var awsKey = localStorage.getItem('aws-key');
	var awsSecret = localStorage.getItem('aws-secret');
	if(awsKey == null || awsSecret == null){
		window.location="./index.html";
	}
	
	var s3 = new AWS.S3({
		accessKeyId:awsKey,
		secretAccessKey:awsSecret
	});
	
	s3.getObject({
		Bucket: 'iot-scheduled-thermostat',
		Key: 'last24hours.json'
	}, function(err, data) {
  		if (err){ 
			console.log(err, err.stack); 
		} else {
			var stat = $.parseJSON(data.Body.toString());
			var dataPoints = [];
			var stripLines = [];
			var scale;
			var stripLine = {color:"rgba(83, 223, 128, .5)"};
			var insideStripLine = false;
			for(i in stat){
				dataPoints.push({x:new Date(stat[i].time), y:stat[i].temperature});
				scale = stat[i].scale;
				if(stat[i].on && !insideStripLine){
					stripLine.startValue = new Date(stat[i].time);
					endValue = true;
				} else if(!stat[i].on && insideStripLine){
					stripLine.startValue = new Date(stat[i].time);
					insideStripLine = false;
					stripLines.push(stripLine);
					stripLine = {color:"rgba(83, 223, 128, .5)"};
				}
			}
			
			var chart = new CanvasJS.Chart("chartContainer", {
				title: {
					text: "Temperature"
				},
				axisX:{
					valueFormatString: "HH:mm",
					stripLines: stripLines
				},
				axisY:{
					title: scale,
				},
				data: [
					{
						type: "spline",
						color: "rgba(83, 223, 128, 1)",
						dataPoints: dataPoints
					}
				],
				toolTip:{
					animationEnabled: true,
   					contentFormatter: function ( e ) {
               			return e.entries[0].dataPoint.x + ": " + e.entries[0].dataPoint.y + " " + scale;
   					}  
 				},    
			});
			chart.render();
		}
	});
}
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.js"></script>
<script type="text/javascript" src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>
</head>
<body>
<div id="chartContainer" style="height: 400px; width: 100%;"></div>
</body>
</html>
